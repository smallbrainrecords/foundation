<section id="clinical-staff-note" ng-if="active_user.role!='patient'"
    ng-show="['problems','mystory'].indexOf(collapse.show_homepage_tab) != -1">
    <div class='panel panel-default'>
        <div class='panel-heading'>Note (office users only)</div>
        <div class='panel-body'>

            <div class="form-group">
                <textarea title="" class='form-control' ng-model='patient_info.note'></textarea>
            </div>
            <div class="form-group">
                <button class='btn btn-primary pull-right' ng-click='update_patient_note()'>
                    Update
                </button>
            </div>
        </div>
    </div>
</section>

<section id="clinical-staff-todo">
    <div class='panel panel-default' ng-if="['secretary','nurse'].indexOf(active_user.role) != -1"
        ng-show='permitted(["add_todo"])'>
        <div class='panel-heading'>Todo</div>
        <div class='panel-body'>
            <form role='form' ng-submit='add_todo(new_todo)'>
                <div class='input-group'>
                    <input title="Todo name" type='text' ng-model='new_todo.name' placeholder="Todo name"
                        class="form-control" id='todoNameInput'>
                    <span class="input-group-btn">
                        <button type='submit' class='btn btn-default'> Add Todo</button>
                    </span>
                </div>
            </form>
            <div class="todo-list-wrapper">
                <div infinite-scroll="loadMoreTodo(false)">
                    <todo todo-list="pending_todos" accomplished="false" show-problem="true"
                        on-status-changed-success="updateStatusCallback" labels="labels" members="members"
                        patient-id="patient_id" user-id="patient_id" active-user="active_user"></todo>
                    <wave-spinner ng-if="todoIsLoading"></wave-spinner>
                </div>

                <button class='btn btn-default btn-block' ng-click='toggle_accomplished_todos()'
                    ng-bind='show_accomplished_todos?"Hide accomplished Todos ":"Show accomplished Todos "'>
                </button>

                <div ng-show='show_accomplished_todos'>
                    <todo todo-list="accomplished_todos" accomplished="true" show-problem="true" labels="labels"
                        members="members" patient-id="patient_id" user-id="patient_id" active-user="active_user"></todo>
                    <wave-spinner ng-if="!accomplishedTodoLoaded"></wave-spinner>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="patient-profile-header">
    <patient-profile-picture profile="patient_info"></patient-profile-picture>

    <div class="home-page-tabs text-center">
        <ul class="nav nav-pills" role="tablist">
            <li role="presentation" ng-class="collapse.show_homepage_tab=='problems' ? 'active': ''">
                <a role="tab" data-toggle="tab" ng-click="change_homepage_tab('problems');">Problems</a>
            </li>
            <li role="presentation" ng-class="collapse.show_homepage_tab=='mystory' ? 'active': ''"
                ng-if="checkSharedMyStory()">
                <a role="tab" data-toggle="tab" ng-click="change_homepage_tab('mystory');">My
                    story</a>
            </li>
            <li role="presentation" ng-class="collapse.show_homepage_tab=='data' ? 'active': ''">
                <a role="tab" data-toggle="tab" ng-click="change_homepage_tab('data');">Data</a>
            </li>
            <li role="presentation" ng-class="collapse.show_homepage_tab=='medication' ? 'active': ''">
                <a role="tab" data-toggle="tab" ng-click="change_homepage_tab('medication');">Medication</a>
            </li>
        </ul>
    </div>

    <div class='row' id="profile-summary" ng-show="['problems','mystory'].indexOf(collapse.show_homepage_tab) != -1">
        <div class="col-md-12">
            <label> Who I am</label>
            <textarea ng-model='patient_info.summary' class='form-control' title="Who I am"></textarea>
            <button class="btn btn-primary pull-right" ng-click="updateSummary()">Update summary</button>
        </div>
    </div>
</section>

<section id="tab-content">
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane tab-problems"
            ng-class="collapse.show_homepage_tab=='problems' ? 'active': ''">
            <div class="row">
                <div class=""
                    ng-class="['secretary','nurse'].indexOf(active_user.role ) == -1 ? 'col-md-6':'col-md-12'">
                    <div class='panel panel-default'>
                        <div class='panel-heading'> Problems</div>
                        <div class='panel-body'>
                            <uib-tabset active="collapse.innerProblemTabSetActive">
                                <uib-tab index="0" heading="Active Problems">
                                    <div>
                                        <ul class='ul-clean no-padding' ui-sortable="sortableOptionsProblem"
                                            ng-model="problems"
                                            ng-if="active_user.role=='physician' || active_user.role=='patient' || active_user.role=='mid-level'">
                                            <li ng-repeat="problem in problems"
                                                ng-show="problem.is_active==true && !inArray(problem_lists, problem)"
                                                ng-click='open_problem(problem)'
                                                ng-if="checkSharedProblem(problem, sharing_patients)">
                                                <div class='item-box'
                                                    ng-class='problem.is_controlled==true ? "green-box" : "red-box" '>
                                                    {{ problem.problem_name }} <span
                                                        ng-show="problem.authenticated==false">(not
                                                        authenticated)</span>
                                                    <a ng-repeat="label in problem.labels" class="todo-label"
                                                        ng-class="label.css_class" ng-if="label.author.id==user_id"></a>
                                                    </span>
                                                    <span ng-repeat="p in sharing_patients"
                                                        ng-if="isInArray(p.problems, problem.id)">
                                                        <img ng-src="{{ p.portrait_image }}" class='tiny-img'>
                                                    </span>
                                                </div>
                                            </li>
                                        </ul>
                                        <ul class='ul-clean no-padding'
                                            ng-if="active_user.role=='admin' || active_user.role=='nurse' || active_user.role=='secretary'">
                                            <li ng-repeat='problem in problems'
                                                ng-show="problem.is_active==true && !inArray(problem_lists, problem)"
                                                ng-click='open_problem(problem)'>

                                                <div class='item-box'
                                                    ng-class='problem.is_controlled==true ? "green-box" : "red-box" '>

                                                    {{ problem.problem_name }} <span
                                                        ng-show="problem.authenticated==false">(not
                                                        authenticated)</span>
                                                    <span ng-repeat="p in sharing_patients"
                                                        ng-if="isInArray(p.problems, problem.id)">
                                                        <img ng-src="{{ p.portrait_image }}" class='tiny-img'>
                                                    </span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </uib-tab>
                                <uib-tab index="1" heading="Inactive Problems">
                                    <div style='max-height:375px; overflow-y:auto;'>
                                        <ul class='ul-clean no-padding' ui-sortable="sortableOptionsProblem"
                                            ng-model="problems"
                                            ng-if="active_user.role=='physician' || active_user.role=='patient' || active_user.role=='mid-level'">
                                            <li ng-repeat="problem in problems"
                                                ng-show="problem.is_active==false && !inArray(problem_lists, problem)"
                                                ng-click='open_problem(problem)'
                                                ng-if="checkSharedProblem(problem, sharing_patients)">
                                                <div class='item-box'
                                                    ng-class='problem.is_controlled==true ? "green-box" : "red-box" '>
                                                    {{ problem.problem_name }} <span
                                                        ng-show="problem.authenticated==false">(not
                                                        authenticated)</span>
                                                    <span ng-repeat="p in sharing_patients"
                                                        ng-if="isInArray(p.problems, problem.id)">
                                                        <img ng-src="{{ p.portrait_image }}" class='tiny-img'>
                                                    </span>
                                                </div>
                                            </li>
                                        </ul>

                                        <ul class='ul-clean no-padding'
                                            ng-if="active_user.role=='admin' || active_user.role=='nurse' || active_user.role=='secretary'">
                                            <li ng-repeat='problem in problems'
                                                ng-show="problem.is_active==false && !inArray(problem_lists, problem)"
                                                ng-click='open_problem(problem)'>

                                                <div class='item-box'
                                                    ng-class='problem.is_controlled==true ? "green-box" : "red-box" '>

                                                    {{ problem.problem_name }} <span
                                                        ng-show="problem.authenticated==false">(not
                                                        authenticated)</span>
                                                    <span ng-repeat="p in sharing_patients"
                                                        ng-if="isInArray(p.problems, problem.id)">
                                                        <img ng-src="{{ p.portrait_image }}" class='tiny-img'>
                                                    </span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </uib-tab>
                                <uib-tab index="2" heading="Add Problem" select="addProblemIsSelected()">
                                    <div class='row' ng-if='permitted(["add_problem"])'>
                                        <div class='col-md-12'>
                                            <div ng-if="['physician','mid-level'].indexOf(active_user.role) != -1">
                                                <div class="input-group">
                                                    <select class='form-control' ng-model="acute_form"
                                                        title="Acute Problem">
                                                        <option ng-repeat="acute in acutes track by $index"
                                                            value="{{ acute.id }}"> {{ acute.problem_name }}
                                                        </option>
                                                    </select>
                                                    <span class="input-group-btn">
                                                        <button class='btn btn-default'
                                                            ng-click='add_new_common_problem(acute_form, "acute")'>
                                                            Add acute problem
                                                        </button>
                                                    </span>
                                                </div>
                                                <br>
                                                <div class="input-group">
                                                    <select class='form-control' ng-model="chronic_form"
                                                        title="Chronic Problem">
                                                        <option ng-repeat="chronic in chronics  track by $index"
                                                            value="{{ chronic.id }}"> {{
                                                            chronic.problem_name }}
                                                        </option>
                                                    </select>
                                                    <span class="input-group-btn">
                                                        <button class='btn btn-default'
                                                            ng-click='add_new_common_problem(chronic_form, "chronic")'>
                                                            Add chronic problem
                                                        </button>
                                                    </span>
                                                </div>
                                                <br>
                                            </div>

                                            <div class="input-group">
                                                <input type='text' ng-model='problem_term' class='form-control'
                                                    id='problemTermInput' auto-focus
                                                    ng-change="problemTermChanged(problem_term)"
                                                    placeholder='Search Problem....'>
                                                <span class="input-group-btn">
                                                    <button class='btn btn-default'
                                                        ng-click='add_new_problem(problem_term)'> Add Problem</button>
                                                </span>
                                            </div>

                                            <div ng-show='new_problem.set==true'>

                                                <label ng-bind="new_problem.code"></label><span
                                                    ng-bind="new_problem.term "></span>
                                                <br>
                                                <button class='btn btn-sm btn-primary' ng-click='add_problem()'>
                                                    Add Problem
                                                </button>
                                                <button class='btn btn-sm btn-danger' ng-click='unset_new_problem()'>
                                                    Cancel
                                                </button>

                                            </div>
                                        </div>
                                        <div class='col-md-12' style='max-height:375px; overflow-y:auto;'>
                                            <div ng-repeat='problem_term in problem_terms track by $index'
                                                style='margin-top:12px;'>
                                                <button class='btn btn-sm btn-default' title='{{ problem_term.code }}'
                                                    ng-click='set_new_problem(problem_term)'>
                                                    {{ problem_term.term }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </uib-tab>
                            </uib-tabset>

                            <div class='panel panel-default' ng-repeat="list in problem_lists track by $index"
                                ng-init="list.collapse=false;list.rename=false;">

                                <div class='panel-heading' ng-click="set_collapse(list);"
                                    ng-class="check_problem_list_controlled(list)? 'red-box' : ''">
                                    <span ng-show="!list.rename">
                                        {{ list.name }} <span>({{ list.problems.length }})</span>
                                        <span ng-if="check_problem_list_authenticated(list)">(not-authenticated)</span>
                                    </span>
                                    <span ng-show="list.rename">
                                        <input type="text" ng-model="list.name">
                                        <button class="btn btn-default"
                                            ng-click="rename_list(list); $event.stopPropagation();">Save</button>
                                        <button class="btn btn-default"
                                            ng-click="list.rename=!list.rename; $event.stopPropagation();">Cancel</button>
                                    </span>
                                    <span ng-show="list.collapse && !list.rename"
                                        ng-if="active_user.role=='physician' || active_user.role=='patient' || active_user.role=='mid-level'">
                                        <a href class="btn btn-danger"
                                            ng-click="delete_list(list); $event.stopPropagation();">Delete</a>
                                        <a href class="btn btn-primary"
                                            ng-click="list.rename=!list.rename; $event.stopPropagation();">Rename</a>
                                    </span>
                                </div>

                                <div class='panel-body' ng-show="list.collapse">
                                    <div class='row'>
                                        <div class='col-md-12'>
                                            <textarea class='form-control' ng-model='list.note'></textarea>
                                            <br>
                                            <button class='btn btn-default' ng-click='update_problem_list_note(list)'>
                                                Update
                                            </button>
                                        </div>
                                    </div>
                                    <br>
                                    <problem ng-model="list.problems" is-list="list.id"></problem>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class='panel panel-default' ng-if="['secretary','nurse'].indexOf(active_user.role ) == -1">
                        <div class='panel-heading'> Todo</div>
                        <div class='panel-body'>
                            <form ng-if='permitted(["add_todo"])' role='form' ng-submit='add_todo(new_todo)'>
                                <div class='input-group'>
                                    <input type='text' ng-model='new_todo.name' placeholder="Todo name"
                                        title="Todo name" class="form-control" id='todoNameInput'>
                                    <span class="input-group-btn"><button type='submit' class='btn btn-default'> Add
                                            Todo</button> </span>
                                </div>
                            </form>

                            <div class="todo-list-wrapper">
                                <div infinite-scroll="loadMoreTodo(false)">
                                    <todo todo-list="pending_todos" show-problem="true"
                                        on-status-changed-success="updateStatusCallback" labels="labels"
                                        members="members" patient-id="patient_id" user-id="patient_id"
                                        active-user="active_user"></todo>
                                    <wave-spinner ng-if="todoIsLoading"></wave-spinner>
                                </div>

                                <button class='btn btn-default btn-block' ng-click='toggle_accomplished_todos()'
                                    ng-bind='show_accomplished_todos?"Hide accomplished Todos ":"Show accomplished Todos "'>
                                </button>

                                <div ng-show='show_accomplished_todos'>
                                    <todo todo-list="accomplished_todos" show-problem="true"
                                        on-status-changed-success="updateStatusCallback" labels="labels"
                                        members="members" patient-id="patient_id" user-id="patient_id"
                                        active-user="active_user"></todo>
                                    <wave-spinner ng-if="!accomplishedTodoLoaded"></wave-spinner>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class='panel panel-default' ng-if="goals.length > 0">
                <div class='panel-heading'>Goals {{ }}</div>
                <div class='panel-body'>
                    <div class='row'>
                        <div class='col-md-12'>
                            <ul class="nav nav-pills no-padding" role="tablist">
                                <li role="presentation" class="active">
                                    <a ng-href=".tab-incomplete-goals" aria-controls="goals" role="tab"
                                        data-toggle="tab">
                                        Current/Incomplete Goals </a>
                                </li>
                                <li role="presentation">
                                    <a ng-href=".tab-completed-goals" aria-controls="incomplete_goals" role="tab"
                                        data-toggle="tab">Completed Goals</a>
                                </li>
                                <li role="presentation" ng-show='permitted(["add_goal"])'>
                                    <a ng-href=".tab-add-goal" aria-controls="add_goal" role="tab" data-toggle="tab">Add
                                        Goal</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active tab-incomplete-goals">
                            <div style='max-height:375px; overflow-y:auto;'>
                                <ul class='ul-clean no-padding'>
                                    <li ng-repeat='goal in goals'
                                        ng-show="(goal.problem && checkSharedProblem(goal.problem, sharing_patients) || !goal.problem)">
                                        <div class='item-box'
                                            ng-class='goal.is_controlled==true ? "green-box" : "red-box" '>
                                            <a class='btn  btn-default btn-sm' ng-href='#/goal/{{ goal.id }}'>
                                                View
                                            </a>

                                            {{ goal.goal }} <span ng-if="goal.problem">for problem <a
                                                    ng-href="#/problem/{{ goal.problem.id }}">{{
                                                    goal.problem.problem_name }}</a></span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane tab-completed-goals">
                            <div style='max-height:375px; overflow-y:auto;'>
                                <ul class='ul-clean no-padding'>
                                    <li ng-repeat='goal in completed_goals'
                                        ng-show="(goal.problem && checkSharedProblem(goal.problem, sharing_patients) || !goal.problem)">
                                        <div class='item-box'
                                            ng-class='goal.is_controlled==true ? "green-box" : "red-box" '>
                                            <a class='btn  btn-default btn-sm' ng-href='#/goal/{{ goal.id }}'>
                                                View
                                            </a>

                                            {{ goal.goal }} <span ng-if="goal.problem">for problem <a
                                                    ng-href="#/problem/{{ goal.problem.id }}">{{
                                                    goal.problem.problem_name }}</a></span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane tab-add-goal" ng-show='permitted(["add_goal"])'>
                            <div class='row'>
                                <div class='col-md-10 col-md-offset-1'>
                                    <form role='form' ng-submit='add_goal(new_goal)'>
                                        <div class='form-group'>
                                            <label> Goal Name </label>
                                            <input type='text' ng-model='new_goal.name' class='form-control'>
                                        </div>
                                        <button type='submit' class='btn btn-default'> Add Goal</button>

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">


                    <div class='panel panel-default' ng-init="encounter_collapse=false;">

                        <div class='panel-heading' ng-click="encounter_collapse=!encounter_collapse;">
                            <i class="fa fa-caret-down" aria-hidden="true" ng-if="encounter_collapse"></i>
                            <i class="fa fa-caret-right" aria-hidden="true" ng-if="!encounter_collapse"></i>
                            Encounters ({{ encounters.length }})
                        </div>

                        <div class='panel-body' style='max-height:325px; overflow:auto' ng-show="encounter_collapse">

                            <ul class='ul-clean no-padding'>
                                <li ng-repeat='encounter in encounters'>
                                    <a ng-href='#/encounter/{{ encounter.id }}'>
                                        From <b> {{ encounter.starttime | date:'medium' }} </b> to
                                        <b>{{ encounter.stoptime | date:'medium' }}</b>
                                    </a>
                                    <span class="float-right">{{ encounter.duration}}</span>
                                </li>
                            </ul>

                        </div>
                    </div>

                    <div ng-if='favorites.length>0' class='panel panel-default'>
                        <div class='panel-heading' ng-click="favorites_collapse=!favorites_collapse;">
                            <i class="fa fa-caret-down" aria-hidden="true"
                                ng-class="favorites_collapse?'fa-caret-down':'fa-caret-right'"></i> Favorites
                        </div>

                        <div class='panel-body' style='max-height:325px; overflow:auto' ng-show="favorites_collapse">
                            <table class='table'>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat='event in favorites track by $index' ng-init="event.is_named=false;">
                                        <td>
                                            <span ng-if="event.is_favorite">
                                                <span ng-if="event.is_named">
                                                    <input type="text" ng-model="event.name_favorite">
                                                    <button class="btn btn-primary"
                                                        ng-click="nameFavoriteEvent(event)">Save</button>
                                                    <button class="btn btn-danger"
                                                        ng-click="event.is_named=!event.is_named;">Cancel</button>
                                                </span>
                                                <span ng-if="!event.is_named">
                                                    {{ event.name_favorite }}
                                                    <a ng-href='#/encounter/{{ event.encounter }}/?startAt={{ event.video_seconds }}'
                                                        class="btn btn-default" target="_blank">Listen</a>
                                                    <button class="btn btn-default"
                                                        ng-click="event.is_named=!event.is_named;">Name</button>
                                                    <button class="btn btn-danger"
                                                        ng-click="unmarkFavoriteEvent(event)">Remove</button>
                                                </span>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class='panel panel-default' ng-init="narrativeCollapsed = false;">
                        <div class='panel-heading' ng-click="narrativeCollapsed  = !narrativeCollapsed ">
                            <i class="fa" ng-class="narrativeCollapsed ? 'fa-caret-down' :'fa-caret-right'"
                                aria-hidden="true"></i>
                            Narrative
                        </div>
                        <div class="panel-body" ng-show="narrativeCollapsed">
                            <textarea msd-elastic class='form-control' title="Narrative" rows="3"
                                ng-model="narratives.latest.description"></textarea>

                            <br>
                            <p>
                                Last edited by: {{ narratives.latest.author }}
                                on {{ narratives.latest.datetime|date:'M/d/yyyy' }}
                                <button class="btn btn-link" ng-click="loadMore(narratives.nextPage)" tabindex="-1">
                                    See previous entries({{ narratives.total }})
                                </button>
                                <button class="btn btn-primary pull-right" ng-click="addNarrative()">Update narrative
                                </button>
                            </p>
                            <br>
                            <div ng-repeat="narrative in narrativeHistories" ng-if="!$first" ng-show="showNarrative">
                                <span ng-bind="narrative.description"></span>
                                <p>by {{ narrative.author }} on {{ narrative.datetime|date:'M/d/yyyy' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" ng-click="graphicFrameIsCollapsed = !graphicFrameIsCollapsed">
                    <i class="fa" ng-class="graphicFrameIsCollapsed?'fa-caret-right':'fa-caret-down'"></i>
                    Graphics
                </div>
                <div class="panel-body" ng-show="!graphicFrameIsCollapsed">
                    <section id="pain-history">
                        <a ng-href="/patient/{{ patient_id }}/pain/add_pain_avatar" class='btn btn-default pull-right'
                            ng-show='permitted(["update_pain"])'> Update Pain </a>
                        <h4>Pain history</h4>
                        <div class="text-center" pain-avatar pain-data='pain_avatars'></div>
                    </section>

                    <section id="problem-timeline">
                        <h4>Problems timeline</h4>
                        <problem-timeline ng-model="timeline"></problem-timeline>
                    </section>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane tab-mystory"
            ng-class="collapse.show_homepage_tab=='mystory' ? 'active': ''" ng-if="checkSharedMyStory();">
            <h3>My Story</h3>
            <br>
            <div class="row my-story">
                <div class="col-sm-3 my-story-left">
                    <ul class='ul-clean my-story-list no-padding'>
                        <li ng-repeat="tab in my_story_tabs" encounter-event data-tab-id="{{ tab.id }}"
                            ng-if="tab.private==false || active_user.role=='patient' || active_user.user.id==tab.author.id">
                            <button class="btn-link" ng-click="view_my_story_tab(tab);"
                                ng-class="{'active': tab==selected_tab}"
                                ng-hide="show_edit_my_story_tab && tab==selected_tab && active_user.user.id==tab.author.id">
                                {{ tab.name }}
                            </button>
                            <div class="row"
                                ng-show="show_edit_my_story_tab && tab==selected_tab && active_user.user.id==tab.author.id">
                                <input type="text" ng-model="selected_tab.name" title="{{ selected_tab.name }}">
                                <button class="btn btn-default" ng-click="save_my_story_tab(selected_tab);">Save
                                </button>
                            </div>
                        </li>
                    </ul>

                    <div class="row">
                        <div class="col-md-12 text-right">
                            <button class="btn btn-primary" ng-click="toggle_add_my_story_tab();"
                                ng-show="!show_add_my_story_tab"
                                ng-if="enableMyStoryEdit && (active_user.role=='physician' || active_user.role=='patient' || active_user.role=='admin')">
                                Add Tab
                            </button>
                            <button ng-click="enableMyStoryEdit = !enableMyStoryEdit" class="btn"
                                ng-class="enableMyStoryEdit ?'btn-danger':'btn-default'"
                                ng-bind="enableMyStoryEdit ? 'Exit' :'Edit'">
                            </button>
                        </div>

                        <div class="col-md-12 col-lg-12 col-sm-12 col-xs-12" ng-if="enableMyStoryEdit">
                            <form ng-show="show_add_my_story_tab" class="form">
                                <div class="form-group">
                                    <input type="text" name="new-tab" ng-model="new_tab.name" class="form-control">
                                </div>
                                <div ng-if="['physician','admin'].indexOf(active_user.role)!=-1">
                                    <div class="radio">
                                        <input type="radio" ng-value="true" checked id="public"
                                            ng-model="new_tab.all_patients">
                                        <label for="public">
                                            All patients
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <input id="private" type="radio" ng-value="" ng-model="new_tab.all_patients">
                                        <label for="private">
                                            Only current patient
                                        </label>
                                    </div>
                                </div>
                                <div ng-if="active_user.role=='patient'">
                                    <div class="radio">
                                        <input id="patient-private" type="radio" ng-value="true" checked
                                            ng-model="new_tab.private">
                                        <label for="patient-private">
                                            Keep it private
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <input id="patient-shared" type="radio" ng-value="" ng-model="new_tab.private">
                                        <label for="patient-shared">
                                            Share with doctor
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group text-right">
                                    <button class="btn btn-primary" ng-click="add_my_story_tab(new_tab);">Save
                                    </button>
                                    <button class="btn btn-danger" ng-click="toggle_add_my_story_tab();">Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-sm-9 my-story-right">
                    <div ng-repeat="(tabIdx,tab) in my_story_tabs" ng-show="selected_tab == tab">
                        <div class="row" ng-repeat="(textComponentIdx,component) in tab.my_story_tab_components"
                            ng-if="component.private==false || active_user.role=='patient' || active_user.user.id==component.author.id">
                            <div class="col-sm-12">
                                <div class="text-component-edit-form">
                                    <b ng-hide="show_edit_my_story_tab && active_user.user.id==component.author.id">
                                        {{ component.name }}
                                    </b>
                                    <span ng-show="show_edit_my_story_tab && active_user.user.id==component.author.id">
                                        <b>Name: </b><input type="text" ng-model="component.name" title="Name">
                                        <b>Concept ID: </b><input type="text" ng-model="component.concept_id"
                                            title="Concept ID">
                                        <button class="btn btn-primary"
                                            ng-click="save_my_story_text(component);">Save</button>
                                        <button class="btn btn-danger" ng-click="delete_my_story_text(component);"
                                            ng-if="active_user.user.id==component.author.id">Delete</button>
                                    </span>
                                </div>

                                <div ng-repeat="(entriesIdx,entry) in component.text_component_entries" ng-if="$first">
                                    <textarea class="tab-components form-control"
                                        id="{{ myStoryTabTextComponentArray.indexOf(component) + 1}}"
                                        ng-model="entry.text"
                                        ng-change="change_component_text(component, entry, oldText)"
                                        ng-click="oldText = entry.text"
                                        ng-model-options="{updateOn: 'blur', debounce: 1000}" title=""></textarea>

                                    <p>Last edited by: {{ entry.author.username }}
                                        on {{ entry.datetime|date:'M/d/yyyy' }}
                                        <button class="btn btn-link" ng-click="see_previous_entries()" tabindex="-1">
                                            See previous entries ({{ component.text_component_entries.length - 1 }})
                                        </button>
                                    </p>
                                </div>
                                <div ng-if="component.text_component_entries.length == 0">
                                    <textarea class="tab-components form-control" ng-model="entry.text"
                                        id="{{ myStoryTabTextComponentArray.indexOf(component) + 1}}"
                                        ng-change="change_component_text(component, entry, oldText)"
                                        ng-click="oldText = entry.text"
                                        ng-model-options="{updateOn: 'blur', debounce: 1000}"></textarea>
                                </div>
                                <div ng-show="show_previous_entries">
                                    <div ng-repeat="entry in component.text_component_entries" ng-if="!$first">
                                        <span ng-bind="entry.text"></span>
                                        <p>by {{ entry.author.username }} on {{ entry.datetime|date:'M/d/yyyy' }}</p>
                                    </div>
                                </div>
                            </div>
                            <br>
                        </div>
                        <br>
                        <div class="row" ng-if="enableMyStoryEdit">
                            <div class="col-sm-6">
                                <button class="btn btn-default" ng-click="toggle_add_my_story_text();"
                                    ng-show="!show_add_my_story_text"
                                    ng-if="active_user.role=='physician' || active_user.role=='patient' || active_user.role=='admin'">
                                    Add Text Component
                                </button>
                                <form class="form-horizontal" ng-show="show_add_my_story_text">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">Name</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" ng-model="new_text.name" title="">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">Text</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" ng-model="new_text.text" title="">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">Snomed concept id</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" ng-model="new_text.concept_id"
                                                title="">
                                        </div>
                                    </div>

                                    <div class="form-group"
                                        ng-if="selected_tab.is_all && ['physician','admin'].indexOf(active_user.role)!= -1">
                                        <div class="col-sm-2"></div>
                                        <div class="col-sm-10">
                                            <div class="radio">
                                                <input id="component-public" type="radio" ng-value="true" checked
                                                    ng-model="new_text.all_patients" title="">
                                                <label for="component-public">
                                                    All patients
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <input id="component-private" type="radio" ng-value=""
                                                    ng-model="new_text.all_patients">
                                                <label for="component-private">
                                                    Only current patient
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group" ng-if="active_user.role=='patient'">
                                        <div class="col-sm-2"></div>
                                        <div class="col-sm-10">
                                            <div class="radio">
                                                <input id="patient-component-private" type="radio" ng-value="true"
                                                    checked ng-model="new_text.private">
                                                <label for="patient-component-private">
                                                    Keep it private
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <input type="radio" ng-value="" ng-model="new_text.private" title=""
                                                    id="patient-component-shared">
                                                <label for="patient-component-shared">
                                                    Share with doctor
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="col-sm-2"></div>
                                        <div class="col-sm-10">
                                            <button class="btn btn-default" ng-click="toggle_add_my_story_text();">
                                                Cancel
                                            </button>
                                            <button class="btn btn-default"
                                                ng-click="add_my_story_text(selected_tab, new_text);">Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="col-sm-6">
                                <button class="btn btn-default pull-right" ng-click="edit_my_story_tab();">
                                    <span ng-show="!show_edit_my_story_tab">Edit</span>
                                    <span ng-show="show_edit_my_story_tab">Cancel</span>
                                </button>
                                <button class="btn btn-default pull-right" ng-show="show_edit_my_story_tab"
                                    ng-click="delete_my_story_tab(selected_tab);"
                                    ng-if="active_user.user.id==selected_tab.author.id">Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane tab-data" ng-class="collapse.show_homepage_tab=='data' ? 'active': ''">
            <div class='panel panel-default'>
                <div class='panel-body'>
                    <div class="row">
                        <div class="col-md-6 no-padding">
                            <a target="_blank" ng-href="#/data/view" class="btn btn-default btn-block">Table view of
                                vitals</a>
                            <div class="btn-group btn-group-justified graph-view-mode"
                                id="homepage-data-time-range-header" patient-homepage-time-range-selector>
                                <label class="btn btn-default" ng-click="viewMode='Week'"
                                    ng-class="viewMode=='Week'?'mode-active':'mode-inactive'">Week</label>
                                <label class="btn btn-default" ng-click="viewMode='Month'"
                                    ng-class="viewMode=='Month'?'mode-active':'mode-inactive'">Month</label>
                                <label class="btn btn-default" ng-click="viewMode='Year'"
                                    ng-class="viewMode=='Year'?'mode-active':'mode-inactive'">Year</label>
                                <label class="btn btn-default" ng-click="viewMode='All'"
                                    ng-class="viewMode=='All'?'mode-active':'mode-inactive'">All</label>
                            </div>

                            <ul class='graph-data-list ul-clean no-padding' ui-sortable="sortableOptionsData"
                                ng-model="datas" ng-if="['physician','patient'].indexOf(active_user.role)!=-1">
                                <li ng-repeat="data in datas" ng-click='open_data(data)'>
                                    <div class='item-box data-frame' ng-style="{'background-color': data.color}">
                                        <div class="row  graph-header">
                                            <div class="col-md-6 text-left">
                                                <h3>{{ data.name }}</h3>
                                            </div>
                                            <div class="col-md-6 text-right">
                                                <h3>
                                                    <span ng-bind="data.mostRecentValue"></span>
                                                    <span ng-repeat='unit in data.observation_units'
                                                        ng-if="unit.is_used"> {{ unit.value_unit }}</span>

                                                </h3>
                                                <span>{{ data.chartLabel[data.chartLabel.length-1]}}</span>

                                            </div>
                                        </div>
                                        <div ng-if="data.observation_components.length > 0">
                                            <canvas ng-if="data.graph=='Line'" class="chart chart-line"
                                                chart-data="data.chartData" chart-series="data.chartSeries"
                                                chart-labels="data.chartLabel"></canvas>
                                            <canvas ng-if="data.graph=='Bar'" class="chart chart-bar"
                                                chart-data="data.chartData" chart-series="data.chartSeries"
                                                chart-labels="data.chartLabel"></canvas>
                                        </div>
                                    </div>
                                </li>
                            </ul>

                            <ul class='graph-data-list ul-clean no-padding'
                                ng-if="['admin','nurse','secretary','mid-level'].indexOf(active_user.role)!=-1">
                                <li ng-repeat="data in datas" ng-click='open_data(data)'>
                                    <div class='item-box data-frame' ng-style="{'background-color': data.color}">
                                        <div class="row  graph-header">
                                            <div class="col-md-6 text-left">
                                                <h3>{{ data.name }}</h3>
                                            </div>
                                            <div class="col-md-6 text-right">
                                                <h3>
                                                    <span ng-bind="data.mostRecentValue"></span>
                                                    <span ng-repeat='unit in data.observation_units'
                                                        ng-if="unit.is_used"> {{ unit.value_unit }}</span>
                                                </h3>
                                                <span>{{ data.chartLabel[data.chartLabel.length-1]}}</span>
                                            </div>
                                        </div>
                                        <div ng-if="data.observation_components.length > 0">
                                            <canvas ng-if="data.graph=='Line'" class="chart chart-line"
                                                chart-data="data.chartData" chart-series="data.chartSeries"
                                                chart-labels="data.chartLabel"></canvas>
                                            <canvas ng-if="data.graph=='Bar'" class="chart chart-bar"
                                                chart-data="data.chartData" chart-series="data.chartSeries"
                                                chart-labels="data.chartLabel"></canvas>
                                        </div>
                                    </div>
                                </li>
                            </ul>

                            <button class="btn btn-default pull-right" ng-show="!show_add_new_data_type"
                                ng-click="toggle_add_new_data_type();"> Add new data type
                            </button>
                            <form class="form-horizontal" ng-show="show_add_new_data_type">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Name</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" ng-model="new_data_type.name" title="">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-4 control-label">LOINC Code</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" ng-model="new_data_type.code" title="">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Unit</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" ng-model="new_data_type.unit">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Color</label>
                                    <div class="col-sm-8">
                                        <color-picker ng-model="new_data_type.color"
                                            options="{format: 'hex'}"></color-picker>
                                    </div>
                                </div>

                                <div class="form-group text-right">
                                    <button class="btn btn-primary" ng-click="add_new_data_type(new_data_type);">
                                        Save
                                    </button>
                                    <button class="btn btn-danger" ng-click="toggle_add_new_data_type();">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="col-md-6">
                            <div class="drop-box" ngf-drop ngf-select ng-model="files" ngf-drag-over-class="'dragover'"
                                ngf-multiple="true">Drop/Click to choose
                                document
                                files
                            </div>
                            <div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>
                            <h3>
                                Pinned documents
                            </h3>
                            <ul class="ul-clean no-padding">
                                <li ng-repeat="document in documents track by $index">
                                    <div>
                                        <a ng-repeat="label in document.labels track by $index" class="todo-label-front"
                                            ng-class="label.css_class"><span ng-bind="label.name"
                                                class="todo-label-name"></span></a>
                                        <a ng-href="#/document/{{ document.id }}" class="flex-item document_name"
                                            target="_blank" ng-bind="document.document_name"></a>
                                        <span class="flex-item document_uploaded_date pull-right"
                                            ng-bind="document.created_on | date:'MM/dd/yyyy'"></span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane tab-medication"
            ng-class="collapse.show_homepage_tab=='medication' ? 'active': ''">
            <medication ng-if="medications" ng-model="medications"></medication>
        </div>
    </div>
</section>

<section id="bdfi" class='bottom-bar container-fluid' ng-show="['patient','nurse'].indexOf(active_user.role) !=-1">
    <div class='row'>
        <div class='col-md-12'>
            <form class="form-inline" ng-if="active_user.role=='nurse'" ng-submit="nurseSubmitBDFI()">
                <div class="form-group" ng-repeat="data in mostCommonData">
                    <input type='text' class='form-control'
                        placeholder='{{ data.name == component.name ? data.ph : data.ph + " " + component.name}}'
                        ng-repeat="component in data.observation_components" ng-change="bdfiValueIsChanged(component)"
                        ng-model="component.new_value">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Submit</button>
                </div>
            </form>

            <form class="form-inline" ng-if="active_user.role=='patient'">
                <div class="form-group" ng-repeat="data in mostCommonData">
                    <input type='text' class='form-control'
                        placeholder='{{ data.name == component.name ? data.name : data.name + " " + component.name}}'
                        ng-repeat="component in data.observation_components" ng-model="component.new_value"
                        ng-change="add_bfdi_value(component)" ng-model-options="{updateOn: 'blur', debounce: 1000}">
                </div>
            </form>
        </div>
    </div>
</section>